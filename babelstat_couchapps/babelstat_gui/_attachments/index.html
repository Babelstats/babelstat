<!DOCTYPE html>
<html>
  <head>
    <title>BabelStat</title>
    <link rel="stylesheet" href="style/main.css" type="text/css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js" type="text/javascript"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js" type="text/javascript"></script>
  </head>
  <body>
    <div id="account"></div>

    <h1>BabelStat</h1>

    <div id="profile"></div>
    <div id="menu">
      <h3>Select your data:</h3>
      <div>
	Categories</br>
	<select id="categories_drop"></select> 
      </div>
      <div>
	Sub categories</br>
	<select id="sub_categories_drop" onchange=></select> 
      </div>
      <div>
	Subjects</br>
	<select id="subjects_drop"></select> 
      </div>
      <div>
	Series categories</br>
	<select id="series_categories_drop"></select> 
      </div>
      <div>
	Series</br>
	<select id="title_drop"></select> 
      </div>
    </div>
    <div id="filter">
      <h3>Set a filter</h3>
      <div>
	From date</br>
	<input type="text" id="datepickerFrom" class="datepicker"></input>
      </div>
      <div>
	To date</br>
	<input type="text" id="datepickerTo" class="datepicker"></input>
      </div>
      <div>
	Frequency</br>
	<select id="frequencies_drop"></select>
      </div>
      <div>
	Scale</br>
	<select id="scale_drop">
	  <option>1</option>
	  <option>10</option>
	  <option>100</option>
	  <option>1000</option>
	  <option>10000</option>
	  <option>100000</option>
	  <option>1000000</option>
	  <option>10000000</option>
	  <option>100000000</option>
	  <option>1000000000</option>
	</select>      
      </div>
      <div>
	Metrics</br>
	<select id="metrics_drop"></select>
      </div>
    </div>
    <input type="button" value="Get Data"></input>
    <div id="data">
      This is your data
    </div>
    <div id="items"></div>

    <div id="sidebar">
      <p>Welcome to Babelstat.</p>
      <p>Select the data you want from the selection box.</p>
    </div>
<!--
    <script type="text/javascript">
	   $(document).ready(function() {	   
	       var fromPicker = $("#datepickerFrom");
	       $("#datepickerFrom").datepicker({clickInput:true});

	    });
    </script>
-->
  </body>  
  <script src="vendor/couchapp/loader.js"></script>
  <script type="text/javascript" charset="utf-8">
    $.couch.app(function(app) {
      $("#account").evently("account", app);
      $("#profile").evently("profile", app);
      $.evently.connect("#account","#profile", ["loggedIn","loggedOut"]);
      $("#items").evently("items", app);

      var baseurl = "http://localhost:15984/babelstat/_design/babelstat_common/_view/";


      $.ajax({url: baseurl+"frequencies?group=true",
             success: function(data){
                                      $("#frequencies_drop").empty().append("<option>Select a frequency</option>"); 
                                      var rows = JSON.parse(data).rows;
                                      rows.forEach(function(row){
                                        $("#frequencies_drop").append("<option>"+row.key+"</option>");                              
                                      })
                                    }       
             });
      $.ajax({url: baseurl+"metrics?group=true",
             success: function(data){
                                      $("#metrics_drop").empty().append("<option>Select a metric</option>"); 
    
                                      var rows = JSON.parse(data).rows;
                                      rows.forEach(function(row){
                                        $("#metrics_drop").append("<option>"+row.key+"</option>");                              
                                      })
                                    }       
             });

      $("#categories_drop").append("<option>Select a category</option>");                              
      $.ajax({url: baseurl+"categories?group=true",
             success: function(data){
                                      var rows = JSON.parse(data).rows;
                                      rows.forEach(function(row){
                                        $("#categories_drop").append("<option>"+row.key+"</option>");                              
                                      })
                                    }       
             });

      $("#categories_drop").change(function(value,ignore){          

          $("#sub_categories_drop").empty().append("<option>Select a sub category</option>"); 
          $.ajax({url: baseurl+'sub_categories?group=true&keys=[\"'+value.target.value+'\"]',
                success: function(data){
                                         var rows = JSON.parse(data).rows;
                                         rows[0].value.forEach(function(row){
                                            $("#sub_categories_drop").append("<option>"+row+"</option>");                              
                                         })
                                       }       
             });         
      });
      $("#sub_categories_drop").change(function(value,ignore){          
          $("#subjects_drop").empty().append("<option>Select a subject</option>"); 

          var category_drp = $("#categories_drop");
          var category = category_drp[0].value
          var sub_category = value.target.value; 
          $.ajax({url: baseurl+'subjects?group=true&start_key=[\"'+category+'\",\"'+sub_category+'\"]&end_key=[\"'+category+'\",\"'+sub_category+'\"]',
                success: function(data){
                                         var rows = JSON.parse(data).rows;
                                         rows[0].value.forEach(function(row){
                                            $("#subjects_drop").append("<option>"+row+"</option>");                              
                                         })
                                       }       
             });         
      });
      $("#subjects_drop").change(function(value,ignore){          
          $("#series_categories_drop").empty().append("<option>Select a series category</option>"); 

          var category = $("#categories_drop")[0].value;
          var sub_category = $("#sub_categories_drop")[0].value; 
          var subject = value.target.value;
          $.ajax({url: baseurl+'series_categories?group=true&start_key=[\"'+category+'\",\"'+sub_category+'\",\"'+subject+'\"]&end_key=[\"'+category+'\",\"'+sub_category+'\",\"'+subject+'\"]',
                success: function(data){
                                         var rows = JSON.parse(data).rows;
                                         rows[0].value.forEach(function(row){
                                            $("#series_categories_drop").append("<option>"+row+"</option>");                              
                                         })
                                       }       
             });         
      });
      $("#series_categories_drop").change(function(value,ignore){          
          $("#title_drop").empty().append("<option>Select a series</option>"); 
          var category = $("#categories_drop")[0].value;
          var sub_category = $("#sub_categories_drop")[0].value; 
          var subject = $("#subjects_drop")[0].value;
          var series_category = value.target.value;
          $.ajax({url: baseurl+'titles?group=true&start_key=[\"'+category+'\",\"'+sub_category+'\",\"'+subject+'\",\"'+series_category+'\"]&end_key=[\"'+category+'\",\"'+sub_category+'\",\"'+subject+'\",\"'+series_category+'\"]',
                success: function(data){
                                         var rows = JSON.parse(data).rows;
                                         rows[0].value.forEach(function(row){
                                            $("#title_drop").append("<option>"+row+"</option>");                              
                                         })
                                       }       
             });         
      });

    });
  </script>    
</html>
